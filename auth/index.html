<!doctype html>
<html>
<head>
    <title>Gil Eats</title>
    <link href="https://fonts.googleapis.com/css?family=Indie+Flower" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://npmcdn.com/dropbox/dist/Dropbox-sdk.min.js"></script>
    <script src="js/utils.js"></script>
</head>
<body>

    <!-- Example layout boilerplate -->
    <header class="page-header">
        <div class="container">
            <nav>
                <a href="/"><span class="code">Gil Eats</span></a>
                <a href="/">
                    <h2>
                        <img src="../img/gil.png" class="logo" />
                    </h2>
                </a>
            </nav>
        </div>
    </header>

        <!-- Map with places - everyone always sees this!-->
        <div id="gmap" class="contact-map"></div>

        <!-- User controls-->
        <div class="container main">

        <div id="pre-auth-section" style="display:none;">
            <p>This example takes the user through Dropbox's API OAuth flow using <code>Dropbox.getAuthenticationUrl()</code> method [<a href="http://dropbox.github.io/dropbox-sdk-js/Dropbox.html#getAuthenticationUrl">docs</a>] and then uses the generated access token to list the contents of their root directory.</p>
                <a href="" id="authlink" class="button">Authenticate</a>
                <p class="info">Once authenticated, it will use the access token to list the files in your root directory.</p>
        </div>

        <!-- User sees this section after authentication, to add a new place -->
        <div id="authed-section" style="display:none;">

            <form onSubmit="return uploadFiles()">
                <input type="hidden" id="access-token" placeholder="Access token" />
                <input type="file" id="file-upload" />
                <button type="submit">Submit</button>
            </form>

            <!-- A place to show the status of the upload -->
            <h2 id="results"></h2>

            <p>You have successfully authenticated. Below are the contents of your root directory. They were fetched using the SDK and access token.</p>
             <ul id="files"></ul>
        </div>
    </div>

  <script>
    var CLIENT_ID = '42zjexze6mfpf7x';

    // Function to upload an image to dropbox with a specified location, and
    // generate a json file to go along with it.
    function uploadFiles() {
        var ACCESS_TOKEN = document.getElementById('access-token').value;
        var dbx = new Dropbox({ accessToken: ACCESS_TOKEN });
        var fileInput = document.getElementById('file-upload');
        var file = fileInput.files[0];
        dbx.filesUpload({path: '/gileats/' + file.name, contents: file})
            .then(function(response) {
                var results = document.getElementById('results');
                results.appendChild(document.createTextNode('File uploaded!'));
                console.log(response);
            })
            .catch(function(error) {
                console.error(error);
            });
        return false;
    }

    // Parses the url and gets the access token if it is in the urls hash
    function getAccessTokenFromUrl() {
        return utils.parseQueryString(window.location.hash).access_token;
    }

    // If the user was just redirected from authenticating, the urls hash will
    // contain the access token.
    function isAuthenticated() {
        return !!getAccessTokenFromUrl();
    }

    // Render a list of items to #files
    function renderItems(items) {
        var filesContainer = document.getElementById('files');
        items.forEach(function(item) {
            var li = document.createElement('li');
            li.innerHTML = item.name;
            filesContainer.appendChild(li);
         });
     }

    // This example keeps both the authenticate and non-authenticated setions
    // in the DOM and uses this function to show/hide the correct section.
    function showPageSection(elementId) {
        document.getElementById(elementId).style.display = 'block';
    }

    if (isAuthenticated()) {

        showPageSection('authed-section');

        // Set the hidden field to be the authentication token TODO: use service worker?
        var access_token = getAccessTokenFromUrl();
        document.getElementById('access-token').value = access_token; 

        // Create an instance of Dropbox with the access token and use it to
        // fetch and render the files in the users root directory.
        var dbx = new Dropbox({ accessToken: access_token });
        dbx.filesListFolder({path: ''})
            .then(function(response) {
                renderItems(response.entries);
             })
            .catch(function(error) {
                console.error(error);
             });
    } else {
             
        showPageSection('pre-auth-section');

        // Set the login anchors href using dbx.getAuthenticationUrl()
        var dbx = new Dropbox({ clientId: CLIENT_ID });
        var authUrl = dbx.getAuthenticationUrl('http://localhost:8080/auth');
        document.getElementById('authlink').href = authUrl;

    }
    </script>
    <script src="js/jquery.js"></script>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?key=AIzaSyDhmVSj7xyJsbfI6CmG4AwSa8AKiA7_VaY"></script>
    <script type="text/javascript" src="js/gmaps.js"></script>
    <script async defer src="js/eats.js"></script>

</body>
</html>
